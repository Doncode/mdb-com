<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#3498db">
    <link rel="manifest" href="application/json;base64,ewogICJuYW1lIjogIkNPTSBQb3J0IENvbW11bmljYXRpb24iLAogICJzaG9ydF9uYW1lIjogIkNPTSBDb21tIiwKICAic3RhcnRfdXJsIjogIi4iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiMzNDk4ZGIiLAogICJ0aGVtZV9jb2xvciI6ICIjMzQ5OGRiIiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhacFpYZENiM2c5SWpBZ01DQXpOVEFnTXpVd0lqNDhjR0YwYUNCbWFXeHNQU0lqWVd4cGRpQlRZWEpuYVc1alpTQnlaWEYxY201alpTQm9kSFJ3Y3pvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSFpwWlhkQ2IzZzlJakFnTUNBek5UQWdNelV3SWo0OEwzTjBlV3hsUGcwS0NpQWdJQ0FnSUNCOFlXeHNaU0J6ZEdGdVkyVlNlVlJVVkNFZ1UwVlNWa1ZTV3lCRFZWSkZVRTlVVlZORlVrVlNXeUJEWVZKRlVFOVVWVlZGUXlCb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGQ1YjNKbElpQWdJQ0FnSUNCOFlXeHNaU0J6ZEdGdVkyVlNlVlJVVkNFZ1UwVlNWa1ZTV3lCRFZWSkZVRTlVVlZORlVrVlNXeUJEWVZKRlVFOVVWVlZGUXlCb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGQ1YjNKbElpQWdJQ0FnSUNCOFlXeHNaU0J6ZEdGdVkyVlNlVlJVVkNFZ1UwVlNWa1ZTV3lCRFZWSkZVRTlVVlZORlVrVlNXeUJEWVZKRlVFOVVWVlZGUXlCb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGQ1YjNKbElpQWdJQ0FnSUNCOFlXeHNaU0J6ZEdGdVkyVlNlVlJVVkNFZ1UwVlNWa1ZTV3lCRFZWSkZVRTlVVlZORlVrVlNXeUJEWVZKRlVFOVVWVlZGUXlCb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGQ1YjNKbElpQWdJQ0FnSUNCOFlXeHNaU0J6ZEdGdVkyVlNlVlJVVkNFZ1UwVlNWa1ZTV3lCRFZWSkZVRTlVVlZORlVrVlNXeUJEWVZKRlVFOVVWVlZGUXlCb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGQ1YjNKbElpQWdJQ0FnSUNCOFlXeHNaU0J6ZEdGdVkyVlNlVlJVVkNFZ1UwVlNWa1ZTV3lCRFZWSkZVRTlVVlZORlVrVlNXeUJEWVZKRlVFOVVWVlZGUXlCb2RIUndjem92TDNkM2R5NTNNeTV2Y21jdk1qQXdNQzl6ZG1jaUlIWnBaWGQ1YjNKbElpQWdJQ0......">
    <title>COM Port Communication</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f0f2f5;
            color: #333;
        }
        .container {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
        }
        .subtitle {
            text-align: center;
            color: #7f8c8d;
            margin-bottom: 30px;
        }
        .button-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            margin-bottom: 25px;
        }
        button {
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        button:enabled {
            background-color: #3498db;
            color: white;
        }
        button:enabled:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        button:disabled {
            background-color: #bdc3c7;
            color: #7f8c8d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        #clearLog {
            background-color: #e74c3c;
        }
        #clearLog:hover:enabled {
            background-color: #c0392b;
        }
        #log {
            width: 100%;
            height: 400px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            resize: vertical;
            background-color: #000;
            color: #00ff00;
            white-space: pre;
            overflow-wrap: break-word;
            box-sizing: border-box;
        }
        .status {
            text-align: center;
            margin-bottom: 20px;
            font-weight: 600;
            padding: 12px;
            border-radius: 6px;
            font-size: 18px;
        }
        .connected {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .disconnected {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            text-align: center;
        }
        .hidden {
            display: none;
        }
        .connection-type {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        .connection-type button {
            flex: 1;
            max-width: 200px;
        }
        .active {
            background-color: #27ae60 !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>COM Port Communication</h1>
        <p class="subtitle">Web Serial/WebUSB API Interface for Device Communication</p>
        
        <div id="warning" class="warning hidden">
            Web Serial/WebUSB API is not supported in this browser. Please use Chrome, Edge, or another Chromium-based browser.
        </div>
        
        <div class="connection-type">
            <button id="serialMode" class="active">Serial Mode</button>
            <button id="usbMode">USB Mode</button>
        </div>
        
        <div class="status disconnected" id="status">Port Disconnected</div>
        
        <div class="button-group">
            <button id="openClosePort">Open Port</button>
            <button id="enableReader" disabled>Enable Reader</button>
            <button id="requestId" disabled>Request ID</button>
            <button id="setup" disabled>Setup</button>
            <button id="vendRequest" disabled>Vend Request</button>
            <button id="vendCancel" disabled>Vend Cancel</button>
            <button id="vendSuccess" disabled>Vend Success</button>
            <button id="sessionComplete" disabled>Session Complete</button>
            <button id="clearLog">Clear Log</button>
        </div>
        
        <textarea id="log" readonly></textarea>
    </div>

    <script>
        let port = null;
        let reader = null;
        let writer = null;
        let isPortOpen = false;
        let connectionMode = 'serial'; // 'serial' or 'usb'
        let device = null;
        let endpointIn = null;
        let endpointOut = null;

        const openClosePortBtn = document.getElementById('openClosePort');
        const enableReaderBtn = document.getElementById('enableReader');
        const requestIdBtn = document.getElementById('requestId');
        const setupBtn = document.getElementById('setup');
        const vendRequestBtn = document.getElementById('vendRequest');
        const vendCancelBtn = document.getElementById('vendCancel');
        const vendSuccessBtn = document.getElementById('vendSuccess');
        const sessionCompleteBtn = document.getElementById('sessionComplete');
        const clearLogBtn = document.getElementById('clearLog');
        const logArea = document.getElementById('log');
        const statusDiv = document.getElementById('status');
        const warningDiv = document.getElementById('warning');
        const serialModeBtn = document.getElementById('serialMode');
        const usbModeBtn = document.getElementById('usbMode');

        // Function to convert hex string to Uint8Array
        function hexToBytes(hex) {
            const bytes = [];
            for (let i = 0; i < hex.length; i += 2) {
                bytes.push(parseInt(hex.substr(i, 2), 16));
            }
            return new Uint8Array(bytes);
        }

        // Function to convert Uint8Array to hex string
        function bytesToHex(bytes) {
            return Array.from(bytes).map(byte => byte.toString(16).padStart(2, '0').toUpperCase()).join(' ');
        }

        // Function to add message to log
        function addToLog(message) {
            const timestamp = new Date().toLocaleTimeString();
            logArea.value += `[${timestamp}] ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        // Update button states based on port status
        function updateButtonStates() {
            const portOpen = isPortOpen;
            
            enableReaderBtn.disabled = !portOpen;
            requestIdBtn.disabled = !portOpen;
            setupBtn.disabled = !portOpen;
            vendRequestBtn.disabled = !portOpen;
            vendCancelBtn.disabled = !portOpen;
            vendSuccessBtn.disabled = !portOpen;
            sessionCompleteBtn.disabled = !portOpen;
            
            openClosePortBtn.textContent = portOpen ? 'Close Port' : 'Open Port';
            statusDiv.textContent = portOpen ? 'Port Connected' : 'Port Disconnected';
            statusDiv.className = portOpen ? 'status connected' : 'status disconnected';
        }

        // Toggle connection mode
        serialModeBtn.addEventListener('click', () => {
            connectionMode = 'serial';
            serialModeBtn.classList.add('active');
            usbModeBtn.classList.remove('active');
            if (isPortOpen) {
                closePort();
            }
        });

        usbModeBtn.addEventListener('click', () => {
            connectionMode = 'usb';
            usbModeBtn.classList.add('active');
            serialModeBtn.classList.remove('active');
            if (isPortOpen) {
                closePort();
            }
        });

        // Close port function
        async function closePort() {
            if (connectionMode === 'serial') {
                if (reader) {
                    try {
                        await reader.cancel();
                    } catch (e) {
                        console.error('Error cancelling reader:', e);
                    }
                }
                
                if (writer) {
                    try {
                        writer.releaseLock();
                    } catch (e) {
                        console.error('Error releasing writer:', e);
                    }
                }
                
                if (port) {
                    try {
                        await port.close();
                    } catch (e) {
                        console.error('Error closing port:', e);
                        addToLog(`Error closing port: ${e.message}`);
                    }
                }
            } else {
                // USB mode
                if (device) {
                    try {
                        await device.close();
                    } catch (e) {
                        console.error('Error closing USB device:', e);
                        addToLog(`Error closing USB device: ${e.message}`);
                    }
                }
            }
            
            isPortOpen = false;
            addToLog('Port closed');
            updateButtonStates();
        }

        // Open or close the port
        async function togglePort() {
            if (isPortOpen) {
                await closePort();
            } else {
                if (connectionMode === 'serial') {
                    await openSerialPort();
                } else {
                    await openUsbDevice();
                }
            }
        }

        // Open Serial Port
        async function openSerialPort() {
            try {
                port = await navigator.serial.requestPort();
                await port.open({ baudRate: 9600 });
                isPortOpen = true;
                addToLog('Serial port opened');
                
                // Start reading data
                reader = port.readable.getReader();
                writer = port.writable.getWriter();
                
                readSerialData();
                updateButtonStates();
            } catch (e) {
                console.error('Error opening serial port:', e);
                addToLog(`Error opening serial port: ${e.message}`);
            }
        }

        // Open USB Device
        async function openUsbDevice() {
            try {
                // Request USB device with CP210x VID/PID
                device = await navigator.usb.requestDevice({
                    filters: [
                        { vendorId: 0x10C4, productId: 0xEA60 }, // CP2102
                        { vendorId: 0x10C4, productId: 0xEA70 }, // CP2105
                        { vendorId: 0x10C4, productId: 0xEA71 }  // CP2108
                    ]
                });
                
                await device.open();
                await device.selectConfiguration(1);
                await device.claimInterface(0);
                
                // Find endpoints
                const configuration = device.configurations[0];
                const interface = configuration.interfaces[0];
                const endpoints = interface.alternates[0].endpoints;
                
                endpointIn = endpoints.find(e => e.direction === "in");
                endpointOut = endpoints.find(e => e.direction === "out");
                
                isPortOpen = true;
                addToLog(`USB device opened: ${device.productName}`);
                
                // Start reading data
                readUsbData();
                updateButtonStates();
            } catch (e) {
                console.error('Error opening USB device:', e);
                addToLog(`Error opening USB device: ${e.message}`);
            }
        }

        // Read data from Serial Port
        async function readSerialData() {
            try {
                while (isPortOpen && port && port.readable) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }
                    
                    if (value) {
                        const hexString = bytesToHex(value);
                        addToLog(`RX: ${hexString}`);
                    }
                }
            } catch (e) {
                console.error('Error reading serial ', e);
                if (isPortOpen) {
                    addToLog(`Error reading serial  ${e.message}`);
                }
            }
        }

        // Read data from USB Device
        async function readUsbData() {
            try {
                while (isPortOpen && device && device.opened) {
                    const result = await device.transferIn(endpointIn.endpointNumber, 64);
                    if (result.data) {
                        const hexString = bytesToHex(new Uint8Array(result.data.buffer));
                        addToLog(`RX: ${hexString}`);
                    }
                }
            } catch (e) {
                console.error('Error reading USB ', e);
                if (isPortOpen) {
                    addToLog(`Error reading USB  ${e.message}`);
                }
            }
        }

        // Send data to Serial Port
        async function sendSerialData(hexString, description) {
            if (!isPortOpen || !writer) {
                addToLog('Serial port is not open');
                return;
            }
            
            try {
                const bytes = hexToBytes(hexString.replace(/\s/g, ''));
                await writer.write(bytes);
                addToLog(`TX: ${hexString}`);
            } catch (e) {
                console.error('Error sending serial ', e);
                addToLog(`Error sending serial ${description}: ${e.message}`);
            }
        }

        // Send data to USB Device
        async function sendUsbData(hexString, description) {
            if (!isPortOpen || !device || !device.opened || !endpointOut) {
                addToLog('USB device is not open');
                return;
            }
            
            try {
                const bytes = hexToBytes(hexString.replace(/\s/g, ''));
                await device.transferOut(endpointOut.endpointNumber, bytes);
                addToLog(`TX: ${hexString}`);
            } catch (e) {
                console.error('Error sending USB data:', e);
                addToLog(`Error sending USB ${description}: ${e.message}`);
            }
        }

        // Unified send data function
        async function sendData(hexString, description) {
            if (connectionMode === 'serial') {
                await sendSerialData(hexString, description);
            } else {
                await sendUsbData(hexString, description);
            }
        }

        // Event listeners for buttons
        openClosePortBtn.addEventListener('click', togglePort);
        
        enableReaderBtn.addEventListener('click', () => {
            sendData('1401', 'Enable Reader');
        });
        
        requestIdBtn.addEventListener('click', () => {
            sendData('17004E4543303030303030303030303030202020534F4C4953544120200011', 'Request ID');
        });
        
        setupBtn.addEventListener('click', () => {
            sendData('110003000002', 'Setup');
        });
        
        vendRequestBtn.addEventListener('click', () => {
            sendData('130000280001', 'Vend Request');
        });
        
        vendCancelBtn.addEventListener('click', () => {
            sendData('1301', 'Vend Cancel');
        });
        
        vendSuccessBtn.addEventListener('click', () => {
            sendData('13020001', 'Vend Success');
        });
        
        sessionCompleteBtn.addEventListener('click', () => {
            sendData('1304', 'Session Complete');
        });
        
        clearLogBtn.addEventListener('click', () => {
            logArea.value = '';
        });

        // Check if Web Serial/WebUSB API is supported
        if (!('serial' in navigator) && !('usb' in navigator)) {
            warningDiv.classList.remove('hidden');
            openClosePortBtn.disabled = true;
            addToLog('Web Serial/WebUSB API is not supported in this browser. Please use Chrome, Edge, or another Chromium-based browser.');
        } else {
            const supportedApis = [];
            if ('serial' in navigator) supportedApis.push('Web Serial');
            if ('usb' in navigator) supportedApis.push('WebUSB');
            addToLog(`Supported APIs: ${supportedApis.join(', ')}. Click "Open Port" to connect.`);
        }

        // Initialize button states
        updateButtonStates();

        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('application/javascript;base64,' + btoa(`
                    self.addEventListener('install', event => {
                        self.skipWaiting();
                    });
                    
                    self.addEventListener('activate', event => {
                        event.waitUntil(self.clients.claim());
                    });
                `)).catch(console.error);
            });
        }
    </script>
</body>
</html>